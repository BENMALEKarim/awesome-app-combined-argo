apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: promotion-workflow-template
spec:
  serviceAccountName: argo-workflow
  entrypoint: promotion-rollout
  templates:
    - name: promotion-rollout
      steps:
        - - name: integration
            template: integration-tests
        - - name: promote
            template: promote
            when: "{{steps.integration.outputs.result}} == success"
          - name: aborte
            template: aborte
            when: "{{steps.integration.outputs.result}} == fail"

    - name: integration-tests
      script:
        image: python:3.12
        command: [python]
        source: |
          import time
          import random
          time.sleep(20)
          result = random.choices(["success", "fail"], weights=[0.9, 0.1])[0]
          print(result)

    - name: promote
      container:
        image: alpine
        command: [sh, -c]
        args: ["echo 'Promoting... SUCCESS'"]

    - name: aborte
      container:
        image: alpine
        command: [sh, -c]
        args: ["echo 'Aborting... FAILURE'"]
